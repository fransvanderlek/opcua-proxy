<?xml version="1.0" encoding="UTF-8"?>
<!-- Configures the Camel Context-->

<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
       http://camel.apache.org/schema/spring http://camel.apache.org/schema/spring/camel-spring.xsd">
       
   	
   	<!-- the embedded opcua server running inside camel based on eclipse Milo -->
   	<bean id="opcua-server"
		class="org.apache.camel.component.milo.server.MiloServerComponent">
		<property name="enableAnonymousAuthentication" value="true" />
		<property name="port" value="12685"/>
		<property name="bindAddresses" value="0.0.0.0"/>
		<property name="applicationName" value="camel-opcua"/>
	</bean>   
	
	<!-- this bean converts json to DataValue object and vice versa -->
	<bean id="gson" class="org.apache.camel.component.gson.GsonDataFormat">     
        <property name="unmarshalType" value="org.eclipse.milo.opcua.stack.core.types.builtin.DataValue"/>   
    </bean>
     

	<camelContext xmlns="http://camel.apache.org/schema/spring">
    	<!--
    	<route id="opcua_source-to-broker">
			<from uri="milo-client:opc.tcp://milo.digitalpetri.com:62541/milo?node=RAW(ns=2;s=Dynamic/RandomDouble)&amp;samplingInterval=100&amp;allowedSecurityPolicies=None" />
       			<marshal>
       				<custom ref="gson"/>
       			</marshal>
       			<convertBodyTo type="java.lang.String"/>
        	<to uri="paho:IntelligentIndustryExperience/robot2/status?brokerUrl=tcp://test.mosquitto.org:1883"/>
		</route>
		
		<route id="broker-to-opcua_replica">
			<from uri="paho:IntelligentIndustryExperience/robot2/status?brokerUrl=tcp://test.mosquitto.org:1883"/>
   				<convertBodyTo type="java.lang.String"/>
   				<unmarshal>
   					<custom ref="gson"/>
   				</unmarshal>
      		
    		<to uri="opcua-server:Dynamic/RandomDouble" />
    	</route> 
    	
    	-->
    	
    	<route id="opcua_replica-init">
  			<from uri="timer://runOnce?repeatCount=1&amp;delay=2000"/>
  				<setBody>
    				<simple>{"value":{"value":2.0},"status":{"value":0},"sourceTime":{"utcTime":132614086977603640},"serverTime":{"utcTime":132614086977603640}}</simple>
  				</setBody>
				<unmarshal>
   					<custom ref="gson"/>
   				</unmarshal>
  			<to uri="log:intelligentindustry?level=INFO"/>	
 			<to uri="opcua-server:some-item"/>
 
  <!--			<to uri="milo-client:opc.tcp://localhost:12685?node=RAW(ns=2;s=some-item)"/> -->
   		</route>
       	
    	<route id="opcua_replica-to-log">
			<from uri="opcua-server:some-item"/>
   			<to uri="log:intelligentindustry?level=INFO"/>
   			<to uri="opcua-server:some-item"/> <!-- adding this 'to' clause causes the value supplied in the 'from' clause to be stored in camel -->
    	</route>
    	
  </camelContext>

</beans>
